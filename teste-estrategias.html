<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste das Estratégias - LotoFácil Estratégica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg card-shadow p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">
                <i class="fas fa-cogs text-blue-600 mr-3"></i>
                Teste das Estratégias
            </h1>
            <p class="text-center text-gray-600 mb-6">
                Validação automática de todas as 8 estratégias do sistema LotoFácil Estratégica
            </p>
            
            <div class="text-center mb-6">
                <button id="testarTodas" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold">
                    <i class="fas fa-play mr-2"></i>
                    Testar Todas as Estratégias
                </button>
            </div>
        </div>

        <div id="resultados" class="space-y-4">
            <!-- Resultados dos testes serão inseridos aqui -->
        </div>

        <div id="resumo" class="bg-white rounded-lg card-shadow p-6 mt-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-chart-bar text-green-600 mr-3"></i>
                Resumo dos Testes
            </h2>
            <div id="resumoContent">
                <!-- Resumo será inserido aqui -->
            </div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
        class TestadorEstrategias {
            constructor() {
                this.lotofacil = new LotofacilEstrategica();
                this.resultados = [];
                this.configurarEventos();
            }

            configurarEventos() {
                document.getElementById('testarTodas').addEventListener('click', () => {
                    this.executarTodosTestes();
                });
            }

            async executarTodosTestes() {
                console.log('Iniciando testes das estratégias...');
                
                document.getElementById('testarTodas').disabled = true;
                document.getElementById('testarTodas').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testando...';
                
                this.resultados = [];
                const container = document.getElementById('resultados');
                container.innerHTML = '';

                // Aguardar inicialização dos números de referência
                await this.aguardarInicializacao();

                // Testar cada estratégia
                for (let i = 1; i <= 8; i++) {
                    const resultado = await this.testarEstrategia(i);
                    this.resultados.push(resultado);
                    this.exibirResultadoEstrategia(resultado);
                    await this.aguardar(500); // Pequena pausa entre testes
                }

                this.exibirResumo();
                
                document.getElementById('testarTodas').disabled = false;
                document.getElementById('testarTodas').innerHTML = '<i class="fas fa-redo mr-2"></i>Testar Novamente';
            }

            async aguardarInicializacao() {
                let tentativas = 0;
                const maxTentativas = 50; // 5 segundos

                while ((!this.lotofacil.numerosReferencia || this.lotofacil.numerosReferencia.length !== 9) && tentativas < maxTentativas) {
                    await this.aguardar(100);
                    tentativas++;
                }

                if (!this.lotofacil.numerosReferencia || this.lotofacil.numerosReferencia.length !== 9) {
                    console.warn('Números de referência não inicializaram corretamente, usando padrão');
                    this.lotofacil.numerosReferencia = [1, 2, 4, 5, 7, 10, 11, 13, 14];
                }

                console.log('Números de referência:', this.lotofacil.numerosReferencia);
            }

            async testarEstrategia(idEstrategia) {
                const nomeEstrategia = this.lotofacil.analises.find(a => a.id === idEstrategia)?.titulo || `Estratégia ${idEstrategia}`;
                
                console.log(`Testando ${nomeEstrategia}...`);
                
                const inicio = performance.now();
                let sucesso = true;
                let erros = [];
                let jogos = [];

                try {
                    // Tentar gerar jogos múltiplas vezes para testar estabilidade
                    for (let tentativa = 1; tentativa <= 3; tentativa++) {
                        try {
                            const jogosGerados = await this.lotofacil.executarEstrategia(idEstrategia);
                            
                            // Validações
                            if (!Array.isArray(jogosGerados)) {
                                throw new Error(`Tentativa ${tentativa}: Resultado não é um array`);
                            }

                            if (jogosGerados.length !== 10) {
                                throw new Error(`Tentativa ${tentativa}: Esperados 10 jogos, obtidos ${jogosGerados.length}`);
                            }

                            // Validar cada jogo
                            for (let i = 0; i < jogosGerados.length; i++) {
                                const jogo = jogosGerados[i];
                                
                                if (!this.lotofacil.validarJogo(jogo)) {
                                    throw new Error(`Tentativa ${tentativa}: Jogo ${i + 1} inválido: ${JSON.stringify(jogo)}`);
                                }
                            }

                            // Verificar uniqueness
                            const jogosUnicos = new Set(jogosGerados.map(j => j.sort((a,b) => a-b).join(',')));
                            if (jogosUnicos.size !== 10) {
                                throw new Error(`Tentativa ${tentativa}: Apenas ${jogosUnicos.size} jogos únicos de 10`);
                            }

                            if (tentativa === 1) {
                                jogos = jogosGerados; // Manter primeira geração para análise
                            }

                        } catch (error) {
                            erros.push(error.message);
                            if (tentativa === 1) {
                                sucesso = false;
                            }
                        }
                    }

                } catch (error) {
                    sucesso = false;
                    erros.push(`Erro geral: ${error.message}`);
                }

                const fim = performance.now();
                const tempoExecucao = fim - inicio;

                return {
                    id: idEstrategia,
                    nome: nomeEstrategia,
                    sucesso,
                    erros,
                    jogos,
                    tempoExecucao: Math.round(tempoExecucao),
                    estatisticas: sucesso ? this.analisarJogos(jogos) : null
                };
            }

            analisarJogos(jogos) {
                if (!jogos || jogos.length === 0) return null;

                const stats = {
                    totalJogos: jogos.length,
                    distribuicaoPares: { 7: 0, 8: 0, outros: 0 },
                    distribuicaoImpares: { 7: 0, 8: 0, outros: 0 },
                    distribuicaoColunas: [0, 0, 0, 0, 0],
                    numerosFrequentes: {},
                    temNumeroReferencia: 0
                };

                for (let jogo of jogos) {
                    // Analisar par/ímpar
                    const pares = jogo.filter(n => n % 2 === 0).length;
                    const impares = 15 - pares;
                    
                    if (pares === 7) stats.distribuicaoPares[7]++;
                    else if (pares === 8) stats.distribuicaoPares[8]++;
                    else stats.distribuicaoPares.outros++;

                    if (impares === 7) stats.distribuicaoImpares[7]++;
                    else if (impares === 8) stats.distribuicaoImpares[8]++;
                    else stats.distribuicaoImpares.outros++;

                    // Analisar distribuição por colunas
                    for (let num of jogo) {
                        const coluna = Math.floor((num - 1) / 5);
                        stats.distribuicaoColunas[coluna]++;
                        
                        // Frequência de números
                        stats.numerosFrequentes[num] = (stats.numerosFrequentes[num] || 0) + 1;
                    }

                    // Verificar se tem pelo menos um número de referência
                    const temRef = jogo.some(n => this.lotofacil.numerosReferencia.includes(n));
                    if (temRef) stats.temNumeroReferencia++;
                }

                return stats;
            }

            exibirResultadoEstrategia(resultado) {
                const container = document.getElementById('resultados');
                const card = document.createElement('div');
                
                const statusClass = resultado.sucesso ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50';
                const statusIcon = resultado.sucesso ? 'fas fa-check-circle text-green-600' : 'fas fa-times-circle text-red-600';
                
                card.className = `border-l-4 ${statusClass} p-4 rounded-lg`;
                
                let conteudo = `
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-lg flex items-center">
                            <i class="${statusIcon} mr-2"></i>
                            ${resultado.nome}
                        </h3>
                        <span class="text-sm text-gray-600">${resultado.tempoExecucao}ms</span>
                    </div>
                `;

                if (resultado.sucesso) {
                    const stats = resultado.estatisticas;
                    conteudo += `
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong>✅ Validações:</strong>
                                <ul class="ml-4 text-green-700">
                                    <li>• 10 jogos únicos gerados</li>
                                    <li>• Todos os jogos válidos (15 números 1-25)</li>
                                    <li>• ${stats.temNumeroReferencia}/10 jogos com números de referência</li>
                                </ul>
                            </div>
                            <div>
                                <strong>📊 Distribuições:</strong>
                                <ul class="ml-4 text-blue-700">
                                    <li>• Pares 7: ${stats.distribuicaoPares[7]}, 8: ${stats.distribuicaoPares[8]}</li>
                                    <li>• Ímpares 7: ${stats.distribuicaoImpares[7]}, 8: ${stats.distribuicaoImpares[8]}</li>
                                    <li>• Colunas: [${stats.distribuicaoColunas.join(', ')}]</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    conteudo += `
                        <div class="text-red-700">
                            <strong>❌ Erros encontrados:</strong>
                            <ul class="ml-4 mt-2">
                                ${resultado.erros.map(erro => `<li>• ${erro}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                card.innerHTML = conteudo;
                container.appendChild(card);
            }

            exibirResumo() {
                const sucessos = this.resultados.filter(r => r.sucesso).length;
                const total = this.resultados.length;
                const tempoTotal = this.resultados.reduce((acc, r) => acc + r.tempoExecucao, 0);

                const resumoDiv = document.getElementById('resumo');
                const content = document.getElementById('resumoContent');

                const porcentagemSucesso = Math.round((sucessos / total) * 100);
                const statusClass = porcentagemSucesso === 100 ? 'text-green-600' : 'text-yellow-600';

                content.innerHTML = `
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold ${statusClass}">${sucessos}/${total}</div>
                            <div class="text-gray-600">Estratégias Aprovadas</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600">${porcentagemSucesso}%</div>
                            <div class="text-gray-600">Taxa de Sucesso</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-purple-600">${tempoTotal}ms</div>
                            <div class="text-gray-600">Tempo Total</div>
                        </div>
                    </div>

                    <div class="mt-6 p-4 ${porcentagemSucesso === 100 ? 'bg-green-100 border border-green-300' : 'bg-yellow-100 border border-yellow-300'} rounded-lg">
                        <h4 class="font-bold mb-2">
                            ${porcentagemSucesso === 100 ? '🎉 Todos os Testes Passaram!' : '⚠️ Alguns Testes Falharam'}
                        </h4>
                        <p class="text-sm">
                            ${porcentagemSucesso === 100 
                                ? 'Todas as estratégias estão funcionando corretamente e gerando 10 jogos únicos conforme especificado na documentação.'
                                : 'Algumas estratégias precisam de ajustes. Verifique os erros acima e corrija os problemas identificados.'
                            }
                        </p>
                    </div>
                `;

                resumoDiv.classList.remove('hidden');
            }

            aguardar(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Inicializar testador quando a página carregar
        window.addEventListener('DOMContentLoaded', () => {
            new TestadorEstrategias();
        });
    </script>
</body>
</html>